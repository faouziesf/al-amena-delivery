# üì¶ Syst√®me de Retours - Documentation Finale

## ‚úÖ Statut: COMPLET ET TEST√â

Tous les composants du syst√®me de retours ont √©t√© impl√©ment√©s avec succ√®s et test√©s.

---

## üìã Nouveaux Statuts de Colis

Le syst√®me utilise maintenant les statuts suivants pour g√©rer les retours:

| Statut | Description | Dur√©e |
|--------|-------------|-------|
| `UNAVAILABLE` | Destinataire indisponible (tentative √©chou√©e) | - |
| `AWAITING_RETURN` | En attente de retour apr√®s 3 tentatives | 48h avant auto-transition |
| `RETURN_IN_PROGRESS` | Retour en cours de traitement au d√©p√¥t | - |
| `RETURNED_TO_CLIENT` | Colis retourn√© au client | 48h pour validation |
| `RETURN_CONFIRMED` | Retour confirm√© par le client | Final |
| `RETURN_ISSUE` | Probl√®me signal√© sur le retour | N√©cessite intervention |

### ‚ö†Ô∏è Statuts Supprim√©s
- `ACCEPTED` (remplac√© par workflow direct)
- `CANCELLED` (non utilis√© dans le nouveau syst√®me)

---

## üîÑ Workflow Complet

### 1. Tentatives de Livraison √âchou√©es
```
CREATED ‚Üí AVAILABLE ‚Üí AT_DEPOT ‚Üí PICKED_UP ‚Üí UNAVAILABLE (x3)
```

### 2. Passage en Retour
```
UNAVAILABLE (3 tentatives) ‚Üí AWAITING_RETURN
```

### 3. Automatisation 48h (Job #1)
```
AWAITING_RETURN (>48h) ‚Üí RETURN_IN_PROGRESS
```
**Job:** `ProcessAwaitingReturnsJob` (ex√©cut√© chaque heure)

### 4. Scan D√©p√¥t et Cr√©ation Colis Retour
```
RETURN_IN_PROGRESS ‚Üí Scan au d√©p√¥t ‚Üí Cr√©ation ReturnPackage
```

### 5. Livraison du Retour
```
ReturnPackage livr√© ‚Üí RETURNED_TO_CLIENT
```

### 6. Validation Client (48h)
```
RETURNED_TO_CLIENT ‚Üí (Client confirme) ‚Üí RETURN_CONFIRMED
                  ‚Üí (Client signale) ‚Üí RETURN_ISSUE
                  ‚Üí (>48h auto) ‚Üí RETURN_CONFIRMED
```
**Job:** `ProcessReturnedPackagesJob` (ex√©cut√© chaque heure)

---

## üèóÔ∏è Structure de la Base de Donn√©es

### Table `return_packages`
Nouvelle table pour g√©rer les colis retours:

```sql
CREATE TABLE return_packages (
    id BIGINT PRIMARY KEY,
    original_package_id BIGINT,  -- FK vers packages
    return_package_code VARCHAR,  -- Code unique RET-XXXXXXXX
    cod DECIMAL(10,2),
    status VARCHAR,              -- AT_DEPOT, DELIVERED
    sender_info JSON,            -- Infos entreprise
    recipient_info JSON,         -- Infos client original
    return_reason TEXT,
    comment TEXT,
    created_by BIGINT,           -- FK vers users
    printed_at TIMESTAMP,
    delivered_at TIMESTAMP,
    assigned_deliverer_id BIGINT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP
);
```

### Colonnes Ajout√©es √† `packages`
```sql
ALTER TABLE packages ADD COLUMN:
- unavailable_attempts INT DEFAULT 0
- awaiting_return_since TIMESTAMP
- return_in_progress_since TIMESTAMP
- returned_to_client_at TIMESTAMP
- return_reason TEXT
- return_package_id BIGINT  -- FK vers return_packages
```

---

## üéØ Interfaces Utilisateur

### 1Ô∏è‚É£ Interface Commercial (`/commercial/packages/{id}`)

**Actions disponibles:**
- ‚úÖ **Lancer 4√®me Tentative** (si statut = AWAITING_RETURN)
  - Remet le colis √† `AT_DEPOT` avec 2 tentatives
  - Route: `POST /commercial/packages/{package}/launch-fourth-attempt`

- ‚úÖ **Changement Manuel de Statut**
  - Permet de modifier manuellement le statut avec raison obligatoire
  - Route: `PATCH /commercial/packages/{package}/change-status`
  - Param√®tres: `new_status`, `change_reason` (max 500 caract√®res)

**Affichage:**
- Section "Gestion des Retours" visible si:
  - Statut = AWAITING_RETURN, RETURN_IN_PROGRESS, etc.
  - OU unavailable_attempts ‚â• 3
  - OU return_reason existe

### 2Ô∏è‚É£ Interface Chef D√©p√¥t Retours

**Dashboard PC** (`/depot/returns`)
- QR Code pour connexion mobile
- Liste des colis retours scann√©s en temps r√©el
- Bouton validation pour cr√©er les colis retours

**Scanner Mobile** (`/depot/returns/phone/{sessionId}`)
- Scanner QR des colis en RETURN_IN_PROGRESS
- V√©rification automatique du statut
- Vibration et feedback visuel
- D√©tection de session termin√©e

**Gestion des Retours** (`/depot/returns/manage`)
- Liste de tous les colis retours cr√©√©s
- Filtres par statut (AT_DEPOT, DELIVERED)
- Impression des bordereaux
- Statistiques

**Routes API:**
```
POST /depot/returns/api/session/{sessionId}/scan
GET  /depot/returns/api/session/{sessionId}/status
GET  /depot/returns/api/session/{sessionId}/check-activity
POST /depot/returns/{sessionId}/validate
GET  /depot/returns/package/{returnPackage}/print
```

### 3Ô∏è‚É£ Interface Client (`/client/returns`)

**Vue d'ensemble:**
- Colis en attente de confirmation (compte √† rebours 48h)
- Retours confirm√©s
- Probl√®mes signal√©s

**Actions:**
- ‚úÖ **Confirmer R√©ception**
  - Route: `POST /client/returns/{package}/confirm`
  - Change le statut ‚Üí `RETURN_CONFIRMED`

- ‚ö†Ô∏è **Signaler un Probl√®me**
  - Route: `POST /client/returns/{package}/report-issue`
  - Param√®tres: `issue_description` (max 1000 caract√®res)
  - Cr√©e une r√©clamation avec priorit√© HIGH
  - Change le statut ‚Üí `RETURN_ISSUE`

---

## ‚öôÔ∏è Jobs Automatis√©s

### ProcessAwaitingReturnsJob
**Fr√©quence:** Toutes les heures (via Scheduler)
**Fonction:** Transition AWAITING_RETURN ‚Üí RETURN_IN_PROGRESS apr√®s 48h

```php
// app/Console/Kernel.php
$schedule->job(new ProcessAwaitingReturnsJob)
    ->hourly()
    ->name('process-awaiting-returns')
    ->runInBackground();
```

**Logique:**
```php
Package::where('status', 'AWAITING_RETURN')
    ->where('awaiting_return_since', '<=', now()->subHours(48))
    ->update([
        'status' => 'RETURN_IN_PROGRESS',
        'return_in_progress_since' => now()
    ]);
```

### ProcessReturnedPackagesJob
**Fr√©quence:** Toutes les heures (via Scheduler)
**Fonction:** Auto-confirmation des retours apr√®s 48h

```php
$schedule->job(new ProcessReturnedPackagesJob)
    ->hourly()
    ->name('process-returned-packages')
    ->runInBackground();
```

**Logique:**
```php
Package::where('status', 'RETURNED_TO_CLIENT')
    ->where('returned_to_client_at', '<=', now()->subHours(48))
    ->update(['status' => 'RETURN_CONFIRMED']);
```

---

## üîß Mod√®les et Relations

### ReturnPackage Model
**Fichier:** `app/Models/ReturnPackage.php`

**Relations:**
- `originalPackage()` ‚Üí Package
- `createdBy()` ‚Üí User
- `assignedDeliverer()` ‚Üí User

**Scopes:**
- `notPrinted()`
- `printed()`
- `atDepot()`
- `delivered()`

**M√©thodes Helper:**
- `isPrinted()` ‚Üí bool
- `markAsPrinted()` ‚Üí void
- `markAsDelivered()` ‚Üí void (met aussi √† jour le package original)
- `static generateReturnCode()` ‚Üí string (format: RET-XXXXXXXX)
- `static getCompanyInfo()` ‚Üí array (infos entreprise)

### Package Model (Extensions)
**Nouvelles Relations:**
- `returnPackage()` ‚Üí ReturnPackage

**Nouveaux Champs Fillable:**
```php
'unavailable_attempts',
'awaiting_return_since',
'return_in_progress_since',
'returned_to_client_at',
'return_reason',
'return_package_id'
```

**Nouveaux Casts:**
```php
'awaiting_return_since' => 'datetime',
'return_in_progress_since' => 'datetime',
'returned_to_client_at' => 'datetime'
```

---

## üß™ Tests

### Script de Test Complet
**Fichier:** `test_complete_return_system.php`

**Ex√©cution:**
```bash
php test_complete_return_system.php
```

**Tests Couverts:**
1. ‚úÖ V√©rification des migrations
2. ‚úÖ Cr√©ation de donn√©es de test
3. ‚úÖ Workflow complet (3 tentatives ‚Üí AWAITING_RETURN)
4. ‚úÖ Job ProcessAwaitingReturnsJob (48h auto)
5. ‚úÖ Cr√©ation colis retour
6. ‚úÖ Livraison retour
7. ‚úÖ Job ProcessReturnedPackagesJob (auto-confirmation)
8. ‚úÖ M√©thodes du mod√®le ReturnPackage

**R√©sultat:**
```
‚úÖ‚úÖ‚úÖ TOUS LES TESTS SONT PASS√âS AVEC SUCC√àS ! ‚úÖ‚úÖ‚úÖ

Le syst√®me de retours fonctionne correctement:
  1. ‚úÖ Migrations OK
  2. ‚úÖ Workflow AWAITING_RETURN ‚Üí RETURN_IN_PROGRESS (48h)
  3. ‚úÖ Cr√©ation colis retour OK
  4. ‚úÖ Livraison retour ‚Üí RETURNED_TO_CLIENT
  5. ‚úÖ Auto-confirmation apr√®s 48h ‚Üí RETURN_CONFIRMED
```

---

## üìù Fichiers Cr√©√©s/Modifi√©s

### Migrations
- ‚úÖ `2025_10_09_063404_add_depot_manager_to_packages_table.php`
- ‚úÖ `2025_10_10_215139_create_return_packages_table.php`
- ‚úÖ `2025_10_10_215241_add_return_fields_to_packages_table.php`

### Mod√®les
- ‚úÖ `app/Models/ReturnPackage.php` (NOUVEAU)
- ‚úÖ `app/Models/Package.php` (MODIFI√â)

### Jobs
- ‚úÖ `app/Jobs/ProcessAwaitingReturnsJob.php` (NOUVEAU)
- ‚úÖ `app/Jobs/ProcessReturnedPackagesJob.php` (NOUVEAU)

### Controllers
- ‚úÖ `app/Http/Controllers/Depot/DepotReturnScanController.php` (NOUVEAU)
- ‚úÖ `app/Http/Controllers/Commercial/PackageController.php` (MODIFI√â)
- ‚úÖ `app/Http/Controllers/Client/ClientDashboardController.php` (MODIFI√â)

### Routes
- ‚úÖ `routes/depot.php` (section retours ajout√©e)
- ‚úÖ `routes/commercial.php` (routes retours ajout√©es)
- ‚úÖ `routes/client.php` (routes retours ajout√©es)

### Vues - D√©p√¥t
- ‚úÖ `resources/views/depot/returns/enter-manager-name.blade.php`
- ‚úÖ `resources/views/depot/returns/scan-dashboard.blade.php`
- ‚úÖ `resources/views/depot/returns/phone-scanner.blade.php`
- ‚úÖ `resources/views/depot/returns/manage.blade.php`
- ‚úÖ `resources/views/depot/returns/show.blade.php`
- ‚úÖ `resources/views/depot/returns/print-label.blade.php`

### Vues - Commercial
- ‚úÖ `resources/views/commercial/packages/show.blade.php` (section retours ajout√©e)
- ‚úÖ `resources/views/commercial/packages/modals/manual-status-change.blade.php`

### Vues - Client
- ‚úÖ `resources/views/client/returns.blade.php`

### Tests
- ‚úÖ `test_return_jobs.php`
- ‚úÖ `test_complete_return_system.php`

---

## üöÄ Mise en Production

### 1. Ex√©cuter les Migrations
```bash
php artisan migrate
```

### 2. V√©rifier le Scheduler
```bash
# Ajouter au crontab (Linux) ou Task Scheduler (Windows)
* * * * * cd /path/to/project && php artisan schedule:run >> /dev/null 2>&1
```

### 3. Test Manuel
```bash
# Tester les jobs manuellement
php artisan queue:work --once

# V√©rifier les logs
php artisan pail
```

### 4. Acc√®s aux Interfaces

**Commercial:**
- Acc√©der √† un colis: `/commercial/packages/{id}`
- Section retours visible automatiquement si applicable

**Chef D√©p√¥t:**
- Dashboard retours: `/depot/returns`
- Gestion: `/depot/returns/manage`

**Client:**
- Mes retours: `/client/returns`

---

## üìä Statistiques et Monitoring

### Logs Automatiques
Tous les √©v√©nements importants sont logg√©s:
- Transition automatique de statut (jobs)
- Cr√©ation de colis retour
- Validation client
- Signalement de probl√®me
- Changements manuels de statut par commercial

### Fichiers de Log
```bash
storage/logs/laravel.log
```

**Exemples:**
```
[2025-10-11] Colis pass√© en RETURN_IN_PROGRESS
    package_id: 123, package_code: PKG-ABC123

[2025-10-11] Colis retour cr√©√©
    return_package_id: 456, return_code: RET-XYZ789

[2025-10-11] Retour confirm√© par le client
    package_id: 123, client_id: 4
```

---

## ‚ö†Ô∏è Points d'Attention

### S√©curit√©
- ‚úÖ Les m√©thodes de controller v√©rifient toujours l'ownership
- ‚úÖ Le changement de statut manuel requiert une raison (tra√ßabilit√©)
- ‚úÖ Les statuts critiques (PAID) ne peuvent pas √™tre modifi√©s

### Performance
- ‚úÖ Les jobs tournent en arri√®re-plan (runInBackground)
- ‚úÖ Index sur les colonnes de recherche (status, dates)
- ‚úÖ Pagination sur toutes les listes

### Validation
- ‚úÖ V√©rification du statut avant toute action
- ‚úÖ Validation des inputs utilisateur
- ‚úÖ Gestion des erreurs avec try-catch

---

## üéâ Conclusion

Le syst√®me de retours est **100% fonctionnel** et **test√© avec succ√®s**.

**Fonctionnalit√©s Cl√©s:**
- ‚úÖ Automatisation compl√®te (jobs 48h)
- ‚úÖ 3 interfaces utilisateur (Commercial, D√©p√¥t, Client)
- ‚úÖ Scan mobile avec QR code
- ‚úÖ Tra√ßabilit√© compl√®te (logs)
- ‚úÖ Gestion des probl√®mes
- ‚úÖ Impression de bordereaux

**Prochaines √âtapes (Optionnelles):**
- üìß Notifications email aux clients
- üì± Notifications push mobile
- üìà Dashboard analytics retours
- üîî Alertes pour retours en retard

---

**Date de Finalisation:** 11 Octobre 2025
**Test√© et Valid√©:** ‚úÖ
**Status:** Production Ready üöÄ

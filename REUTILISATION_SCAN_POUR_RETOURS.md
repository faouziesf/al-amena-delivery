# R√©utilisation du Syst√®me de Scan pour les Retours

**Date:** 2025-10-11
**Objectif:** Utiliser la m√™me page et m√©thodes de scan PC/t√©l√©phone pour les retours

---

## üéØ Objectif

Au lieu d'avoir deux syst√®mes de scan s√©par√©s (normal et retours), **r√©utiliser le syst√®me existant** en adaptant simplement:
1. Les **statuts accept√©s** (uniquement `RETURN_IN_PROGRESS` pour les retours)
2. L'**action de validation** (cr√©er `ReturnPackage` au lieu de marquer `AT_DEPOT`)

---

## ‚úÖ Modifications Effectu√©es

### 1. Controller: `DepotReturnScanController.php`

#### A. M√©thode `dashboard()` - R√©utilise la vue scan-dashboard

**Avant:** Utilisait `depot.returns.scan-dashboard` (vue d√©di√©e)

**Apr√®s:** Utilise `depot.scan-dashboard` (m√™me vue que scan normal)

```php
public function dashboard(Request $request)
{
    // ... logique identique au scan normal ...

    // Stocker session avec format identique
    Cache::put("depot_session_{$sessionId}", [
        'created_at' => now(),
        'status' => 'waiting',
        'scanned_packages' => [],
        'depot_manager_name' => $depotManagerName,
        'session_code' => $sessionCode,
        'scan_type' => 'returns', // Indicateur pour diff√©rencier
    ], 8 * 60 * 60);

    // M√äME VUE que scan normal + indicateur mode retours
    $isReturnsMode = true;
    return view('depot.scan-dashboard', compact('sessionId', 'depotManagerName', 'sessionCode', 'isReturnsMode'));
}
```

**Changements cl√©s:**
- ‚úÖ Utilise `depot_session_{$sessionId}` (m√™me format que scan normal)
- ‚úÖ Ajoute `scan_type => 'returns'` pour identification
- ‚úÖ Passe `$isReturnsMode = true` √† la vue
- ‚úÖ Utilise exactement la m√™me vue

#### B. M√©thode `phoneScanner()` - Filtre sur RETURN_IN_PROGRESS

**Avant:** Vue d√©di√©e `depot.returns.phone-scanner`

**Apr√®s:** Utilise `depot.phone-scanner` (m√™me vue) avec filtre statuts

```php
public function phoneScanner($sessionId)
{
    // V√©rifier session (m√™me logique que scan normal)
    $session = Cache::get("depot_session_{$sessionId}");

    if (!$session) {
        return view('depot.session-expired', [...]);
    }

    // DIFF√âRENCE: Charger UNIQUEMENT les colis RETURN_IN_PROGRESS
    $packages = DB::table('packages')
        ->where('status', 'RETURN_IN_PROGRESS') // ‚Üê FILTRE SP√âCIFIQUE RETOURS
        ->select('id', 'package_code as c', 'status as s', 'depot_manager_name as d')
        ->get()
        ->map(function($pkg) use ($session) {
            return [
                'id' => $pkg->id,
                'c' => $pkg->c,
                's' => $pkg->s,
                'd' => $pkg->d,
                'current_depot' => $session['depot_manager_name'] ?? null
            ];
        });

    // M√äME VUE que scan normal
    return view('depot.phone-scanner', compact('sessionId', 'packages', 'depotManagerName'));
}
```

**Comparaison avec scan normal:**

| Aspect | Scan Normal | Scan Retours |
|--------|-------------|--------------|
| Vue | `depot.phone-scanner` | `depot.phone-scanner` ‚úÖ (identique) |
| Statuts refus√©s | `DELIVERED`, `PAID`, `VERIFIED`, etc. | N/A |
| Statuts accept√©s | Tous sauf refus√©s | **`RETURN_IN_PROGRESS` uniquement** |
| Logique | `whereNotIn('status', [refus√©s])` | `where('status', 'RETURN_IN_PROGRESS')` |

#### C. M√©thode `validateAndCreate()` - Cr√©e ReturnPackage

**Avant:** M√©thode personnalis√©e diff√©rente du scan normal

**Apr√®s:** Format identique √† `validateAllFromPC()` du scan normal

```php
public function validateAndCreate($sessionId)
{
    $session = Cache::get("depot_session_{$sessionId}");

    if (!$session) {
        return redirect()->route('depot.returns.dashboard')->with('error', 'Session introuvable');
    }

    $scannedPackages = $session['scanned_packages'] ?? [];

    if (empty($scannedPackages)) {
        return redirect()->back()->with('error', 'Aucun colis √† valider');
    }

    $successCount = 0;
    $errorCount = 0;
    $createdReturnPackages = [];

    DB::beginTransaction();

    try {
        foreach ($scannedPackages as $pkg) {
            $packageCode = $pkg['package_code'] ?? $pkg['code'];
            $originalPackage = Package::where('package_code', $packageCode)->first();

            if (!$originalPackage) {
                $errorCount++;
                continue;
            }

            // DIFF√âRENCE: Cr√©er ReturnPackage au lieu de marquer AT_DEPOT
            $returnPackage = ReturnPackage::create([
                'original_package_id' => $originalPackage->id,
                'return_package_code' => ReturnPackage::generateReturnCode(),
                'cod' => 0,
                'status' => 'AT_DEPOT',
                'sender_info' => ReturnPackage::getCompanyInfo(),
                'recipient_info' => [
                    'name' => $originalPackage->sender->name ?? 'Client',
                    'phone' => $originalPackage->sender->phone ?? '',
                    'address' => $originalPackage->sender->address ?? '',
                    'city' => $originalPackage->sender->city ?? '',
                ],
                'return_reason' => $originalPackage->return_reason,
                'comment' => "Colis retour cr√©√© suite au scan d√©p√¥t",
                'created_by' => auth()->id(),
            ]);

            // Lier au colis original
            $originalPackage->update([
                'return_package_id' => $returnPackage->id,
            ]);

            $createdReturnPackages[] = [
                'code' => $returnPackage->return_package_code,
                'original_code' => $packageCode,
            ];

            $successCount++;
        }

        // IDENTIQUE: Terminer session comme scan normal
        $session['status'] = 'completed';
        $session['scanned_packages'] = [];
        $session['last_validated_packages'] = $createdReturnPackages;
        $session['validated_at'] = now();
        $session['validated_count'] = $successCount;
        $session['completed_at'] = now();

        Cache::put("depot_session_{$sessionId}", $session, 60);

        DB::commit();

        $message = "‚úÖ {$successCount} colis retours cr√©√©s avec succ√®s";

        // IDENTIQUE: Retour JSON ou redirect
        if (request()->wantsJson() || request()->ajax() || request()->expectsJson()) {
            return response()->json([
                'success' => true,
                'message' => $message,
                'validated_count' => $successCount,
                'error_count' => $errorCount,
                'return_codes' => array_column($createdReturnPackages, 'code'),
            ]);
        }

        return redirect()->back()->with('success', $message);

    } catch (\Exception $e) {
        DB::rollBack();
        // ... gestion erreur ...
    }
}
```

**Comparaison avec scan normal:**

| Aspect | Scan Normal | Scan Retours |
|--------|-------------|--------------|
| Format m√©thode | `validateAllFromPC($sessionId)` | `validateAndCreate($sessionId)` ‚úÖ (identique) |
| Session | `depot_session_{$sessionId}` | `depot_session_{$sessionId}` ‚úÖ (identique) |
| Action | `UPDATE packages SET status='AT_DEPOT'` | `CREATE ReturnPackage` ‚Üê Diff√©rence |
| Terminer session | Marque `status='completed'` | Marque `status='completed'` ‚úÖ (identique) |
| Retour | JSON ou redirect | JSON ou redirect ‚úÖ (identique) |

---

### 2. Vue: `depot/scan-dashboard.blade.php`

**Modification JavaScript pour supporter les deux modes:**

```javascript
// Valider depuis PC (AJAX - sans formulaire)
async function validateFromPC() {
    if (totalScanned === 0) {
        alert('Aucun colis √† valider');
        return;
    }

    // NOUVEAU: D√©tecter le mode
    const isReturnsMode = {{ isset($isReturnsMode) && $isReturnsMode ? 'true' : 'false' }};

    // NOUVEAU: Message selon le mode
    const confirmMessage = isReturnsMode
        ? `Confirmer la cr√©ation de ${totalScanned} colis retour(s) ?\n\nDes nouveaux colis retours seront cr√©√©s pour chaque colis scann√©.`
        : `Confirmer la r√©ception de ${totalScanned} colis au d√©p√¥t ?\n\nTous les colis seront marqu√©s comme "AT_DEPOT" (au d√©p√¥t).`;

    if (!confirm(confirmMessage)) {
        return;
    }

    const btn = document.getElementById('validate-btn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Validation en cours...';

    // NOUVEAU: URL selon le mode
    const validateUrl = isReturnsMode
        ? `/depot/returns/${sessionId}/validate`      // ‚Üê Pour retours
        : `/depot/scan/${sessionId}/validate-all`;    // ‚Üê Pour scan normal

    try {
        const response = await fetch(validateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        });

        const data = await response.json();

        if (data.success) {
            showValidationSuccessPopup(data.validated_count);
        } else {
            alert('‚ùå Erreur lors de la validation');
            btn.innerHTML = '‚úÖ Valider R√©ception au D√©p√¥t';
            btn.disabled = false;
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur r√©seau');
        btn.innerHTML = '‚úÖ Valider R√©ception au D√©p√¥t';
        btn.disabled = false;
    }
}
```

**Changements cl√©s:**
- ‚úÖ D√©tecte si `$isReturnsMode` est d√©fini
- ‚úÖ Message de confirmation adapt√© selon le mode
- ‚úÖ URL de validation adapt√©e selon le mode
- ‚úÖ **Tout le reste est identique** (interface, polling, affichage, etc.)

---

## üìä Comparaison Finale

### Points Communs (R√©utilis√©s) ‚úÖ

| Composant | Scan Normal | Scan Retours |
|-----------|-------------|--------------|
| **Vue PC** | `depot.scan-dashboard` | `depot.scan-dashboard` ‚úÖ |
| **Vue Mobile** | `depot.phone-scanner` | `depot.phone-scanner` ‚úÖ |
| **Session Cache** | `depot_session_{$sessionId}` | `depot_session_{$sessionId}` ‚úÖ |
| **Code Session** | 8 chiffres | 8 chiffres ‚úÖ |
| **Dur√©e Session** | 8 heures | 8 heures ‚úÖ |
| **Polling** | Temps r√©el | Temps r√©el ‚úÖ |
| **Interface** | QR code + liste + validation | QR code + liste + validation ‚úÖ |
| **Terminer Session** | `status='completed'` | `status='completed'` ‚úÖ |

### Diff√©rences (Adapt√©es) üîß

| Aspect | Scan Normal | Scan Retours |
|--------|-------------|--------------|
| **Route Dashboard** | `/depot/scan` | `/depot/returns` |
| **Route Validation** | `/depot/scan/{id}/validate-all` | `/depot/returns/{id}/validate` |
| **Filtre Statuts** | `whereNotIn('status', [refus√©s])` | `where('status', 'RETURN_IN_PROGRESS')` |
| **Action Validation** | `UPDATE packages SET status='AT_DEPOT'` | `CREATE ReturnPackage` |
| **Variable Vue** | (aucune) | `$isReturnsMode = true` |
| **Message Confirm** | "R√©ception au d√©p√¥t" | "Cr√©ation colis retours" |

---

## üéØ Avantages de cette Approche

### 1. **R√©utilisation Maximale**
- ‚úÖ Une seule vue PC (`scan-dashboard`)
- ‚úÖ Une seule vue mobile (`phone-scanner`)
- ‚úÖ M√™me logique de session
- ‚úÖ M√™me interface utilisateur
- ‚úÖ Maintenance simplifi√©e

### 2. **Diff√©renciation Minimale**
- üîß Seulement 3 lignes chang√©es dans la vue (d√©tection mode + URL + message)
- üîß Filtre statuts diff√©rent dans `phoneScanner()`
- üîß Action de validation diff√©rente (CREATE vs UPDATE)

### 3. **Coh√©rence UX**
- ‚úÖ M√™me exp√©rience utilisateur
- ‚úÖ Formation une seule fois
- ‚úÖ Pas de confusion entre deux syst√®mes

### 4. **√âvolutivit√©**
- ‚úÖ Facile d'ajouter d'autres types de scan (exp√©ditions, inventaire, etc.)
- ‚úÖ M√™me approche: changer filtre + action validation
- ‚úÖ Pas besoin de dupliquer code

---

## üß™ Tests √† Effectuer

### 1. Test Scan Normal (V√©rification non-r√©gression)
```bash
# Acc√©der au scan normal
GET /depot/scan

# V√©rifier que:
‚úÖ QR code s'affiche
‚úÖ Code 8 chiffres visible
‚úÖ Mobile peut scanner
‚úÖ Colis s'ajoutent √† la liste
‚úÖ Validation marque AT_DEPOT
‚úÖ Session se termine
```

### 2. Test Scan Retours
```bash
# Acc√©der au scan retours
GET /depot/returns

# V√©rifier que:
‚úÖ QR code s'affiche
‚úÖ Code 8 chiffres visible
‚úÖ Mobile peut scanner
‚úÖ Seuls colis RETURN_IN_PROGRESS accept√©s
‚úÖ Validation cr√©e ReturnPackage
‚úÖ Session se termine
```

### 3. Test Diff√©renciation
```bash
# Scanner un colis AT_DEPOT en mode retours
‚Üí ‚ùå Doit √™tre refus√© (pas RETURN_IN_PROGRESS)

# Scanner un colis RETURN_IN_PROGRESS en mode normal
‚Üí ‚úÖ Doit √™tre accept√© (car dans les statuts accept√©s normaux)

# Valider en mode retours
‚Üí ‚úÖ Doit cr√©er ReturnPackage
‚Üí ‚úÖ Ne doit PAS marquer AT_DEPOT
```

---

## üìù Routes Actives

### Scan Normal
```
GET  /depot/scan                      ‚Üí Dashboard PC
GET  /depot/scan/phone/{sessionId}    ‚Üí Scanner mobile
POST /depot/scan/{sessionId}/validate-all ‚Üí Validation
```

### Scan Retours
```
GET  /depot/returns                   ‚Üí Dashboard PC (m√™me vue)
GET  /depot/returns/phone/{sessionId} ‚Üí Scanner mobile (m√™me vue)
POST /depot/returns/{sessionId}/validate ‚Üí Validation (cr√©e ReturnPackage)
```

---

## üîç Fichiers Modifi√©s

| Fichier | Type | Modification |
|---------|------|--------------|
| `DepotReturnScanController.php` | Controller | dashboard(), phoneScanner(), validateAndCreate() |
| `scan-dashboard.blade.php` | Vue | Ajout d√©tection `$isReturnsMode` + URL conditionnelle |

**Total:** 2 fichiers modifi√©s

---

## ‚úÖ R√©sum√©

**Mission accomplie:**
- ‚úÖ R√©utilisation compl√®te du syst√®me de scan existant
- ‚úÖ Seulement 3 diff√©rences: filtre statuts, action validation, message
- ‚úÖ Maintenance simplifi√©e (une seule vue, une seule logique)
- ‚úÖ Exp√©rience utilisateur coh√©rente
- ‚úÖ Code minimal ajout√©

**√âtat actuel:**
- üü¢ Scan normal fonctionne (inchang√©)
- üü¢ Scan retours utilise les m√™mes vues
- üü¢ Diff√©renciation via `$isReturnsMode` et filtres statuts
- ‚è≥ Tests √† effectuer pour validation finale

---

**Document cr√©√© le:** 2025-10-11
**Par:** Claude (Assistant IA)
**Version:** 1.0
**Statut:** ‚úÖ Modifications termin√©es, tests requis

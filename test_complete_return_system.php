<?php

/**
 * Script de Test Complet - Syst√®me de Retours
 *
 * Ce script teste l'ensemble du workflow:
 * 1. Migrations et mod√®les
 * 2. Cr√©ation de donn√©es de test
 * 3. Jobs automatiques (48h)
 * 4. Workflow complet du retour
 */

require __DIR__ . '/vendor/autoload.php';

$app = require_once __DIR__ . '/bootstrap/app.php';
$app->make(Illuminate\Contracts\Console\Kernel::class)->bootstrap();

use App\Models\User;
use App\Models\Package;
use App\Models\ReturnPackage;
use App\Models\Delegation;
use App\Jobs\ProcessAwaitingReturnsJob;
use App\Jobs\ProcessReturnedPackagesJob;
use Illuminate\Support\Facades\DB;

echo "\n";
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
echo "   TEST COMPLET - SYST√àME DE RETOURS AL-AMENA DELIVERY\n";
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";

// ============================================================================
// √âTAPE 1: V√©rification des migrations
// ============================================================================
echo "üìã √âTAPE 1: V√©rification des migrations...\n";
echo str_repeat("-", 60) . "\n";

try {
    // V√©rifier la table return_packages
    $returnPackagesExists = DB::table('return_packages')->count() >= 0;
    echo "‚úÖ Table 'return_packages' existe\n";

    // V√©rifier les colonnes du package
    $packageColumns = DB::select("PRAGMA table_info(packages)");
    $returnFieldsExists = false;
    foreach ($packageColumns as $col) {
        if ($col->name === 'return_package_id') {
            $returnFieldsExists = true;
            break;
        }
    }

    if ($returnFieldsExists) {
        echo "‚úÖ Colonnes de retour ajout√©es √† la table 'packages'\n";
    } else {
        echo "‚ùå Colonnes de retour manquantes dans 'packages'\n";
    }

} catch (\Exception $e) {
    echo "‚ùå Erreur migrations: " . $e->getMessage() . "\n";
    exit(1);
}

echo "\n";

// ============================================================================
// √âTAPE 2: Cr√©ation de donn√©es de test
// ============================================================================
echo "üîß √âTAPE 2: Cr√©ation de donn√©es de test...\n";
echo str_repeat("-", 60) . "\n";

// Cr√©er un client de test
$client = User::where('role', 'CLIENT')->first();
if (!$client) {
    $client = User::create([
        'name' => 'Client Test Retours',
        'email' => 'client_retour_test_' . uniqid() . '@test.com',
        'password' => bcrypt('password'),
        'role' => 'CLIENT',
        'account_status' => 'ACTIVE',
        'phone' => '50123456',
    ]);
    echo "‚úÖ Client de test cr√©√©: {$client->name} (ID: {$client->id})\n";
} else {
    echo "‚úÖ Utilisation du client existant: {$client->name} (ID: {$client->id})\n";
}

// Cr√©er d√©l√©gation si n√©cessaire
$delegation = Delegation::first();
if (!$delegation) {
    $delegation = Delegation::create([
        'name' => 'Tunis Centre',
        'code' => 'TUN-CTR',
        'is_active' => true,
    ]);
    echo "‚úÖ D√©l√©gation cr√©√©e: {$delegation->name}\n";
} else {
    echo "‚úÖ Utilisation d√©l√©gation: {$delegation->name}\n";
}

echo "\n";

// ============================================================================
// √âTAPE 3: Test du workflow complet
// ============================================================================
echo "üîÑ √âTAPE 3: Test du workflow complet...\n";
echo str_repeat("-", 60) . "\n";

// 3.1 Cr√©er un colis
echo "\n3.1 - Cr√©ation d'un colis...\n";
$package = Package::create([
    'sender_id' => $client->id,
    'package_code' => 'TEST-RET-' . strtoupper(substr(md5(uniqid()), 0, 6)),
    'tracking_number' => 'TRK-' . time(),
    'status' => 'AT_DEPOT',
    'cod_amount' => 150.00,
    'delivery_type' => 'standard',
    'recipient_data' => [
        'name' => 'Destinataire Test',
        'phone' => '20123456',
        'address' => '123 Rue Test',
        'city' => 'Tunis',
    ],
    'delegation_from_id' => $delegation->id,
    'delegation_to_id' => $delegation->id,
    'unavailable_attempts' => 0,
]);

echo "   ‚úÖ Colis cr√©√©: {$package->package_code} (Statut: {$package->status})\n";

// 3.2 Simuler 3 tentatives √©chou√©es
echo "\n3.2 - Simulation de 3 tentatives de livraison √©chou√©es...\n";
for ($i = 1; $i <= 3; $i++) {
    $package->update([
        'status' => 'UNAVAILABLE',
        'unavailable_attempts' => $i,
    ]);
    echo "   ‚è≥ Tentative {$i}/3 √©chou√©e\n";
}

// Passer en AWAITING_RETURN
$package->update([
    'status' => 'AWAITING_RETURN',
    'awaiting_return_since' => now()->subHours(50), // 50h dans le pass√© pour test
    'return_reason' => 'Destinataire injoignable apr√®s 3 tentatives',
]);

echo "   ‚úÖ Colis pass√© en AWAITING_RETURN (depuis 50h)\n";

// 3.3 Test du job ProcessAwaitingReturnsJob
echo "\n3.3 - Test du job ProcessAwaitingReturnsJob (48h auto)...\n";
$job1 = new ProcessAwaitingReturnsJob();
$job1->handle();

$package->refresh();
echo "   ‚úÖ Job ex√©cut√© - Statut actuel: {$package->status}\n";

if ($package->status === 'RETURN_IN_PROGRESS') {
    echo "   ‚úÖ SUCC√àS: Le colis est pass√© en RETURN_IN_PROGRESS automatiquement\n";
} else {
    echo "   ‚ö†Ô∏è  Le colis est rest√© en {$package->status}\n";
}

// 3.4 Simuler scan d√©p√¥t et cr√©ation colis retour
echo "\n3.4 - Simulation scan d√©p√¥t et cr√©ation colis retour...\n";

if ($package->status === 'RETURN_IN_PROGRESS') {
    $returnPackage = ReturnPackage::create([
        'original_package_id' => $package->id,
        'return_package_code' => ReturnPackage::generateReturnCode(),
        'cod' => 0,
        'status' => 'AT_DEPOT',
        'sender_info' => ReturnPackage::getCompanyInfo(),
        'recipient_info' => [
            'name' => $client->name,
            'phone' => $client->phone,
            'address' => $client->address ?? 'Adresse client',
            'city' => 'Tunis',
        ],
        'return_reason' => $package->return_reason,
        'comment' => 'Colis retour cr√©√© par test automatique',
        'created_by' => null,
    ]);

    $package->update([
        'return_package_id' => $returnPackage->id,
    ]);

    echo "   ‚úÖ Colis retour cr√©√©: {$returnPackage->return_package_code}\n";

    // Simuler livraison du colis retour au client
    echo "\n3.5 - Simulation livraison du colis retour...\n";
    $returnPackage->markAsDelivered();
    $package->refresh();

    echo "   ‚úÖ Colis retour livr√© - Statut package: {$package->status}\n";
    echo "   ‚úÖ Date retour client: {$package->returned_to_client_at}\n";

    // Modifier la date pour test auto-confirmation
    $package->update([
        'returned_to_client_at' => now()->subHours(50), // 50h dans le pass√©
    ]);

    // 3.6 Test du job ProcessReturnedPackagesJob
    echo "\n3.6 - Test du job ProcessReturnedPackagesJob (auto-confirmation 48h)...\n";
    $job2 = new ProcessReturnedPackagesJob();
    $job2->handle();

    $package->refresh();
    echo "   ‚úÖ Job ex√©cut√© - Statut final: {$package->status}\n";

    if ($package->status === 'RETURN_CONFIRMED') {
        echo "   ‚úÖ SUCC√àS: Le retour a √©t√© auto-confirm√© apr√®s 48h\n";
    } else {
        echo "   ‚ö†Ô∏è  Le colis est en {$package->status}\n";
    }
}

echo "\n";

// ============================================================================
// √âTAPE 4: R√©sum√© des tests
// ============================================================================
echo "üìä √âTAPE 4: R√©sum√© des r√©sultats...\n";
echo str_repeat("-", 60) . "\n\n";

$package->refresh();
$returnPackage->refresh();

echo "üì¶ COLIS ORIGINAL:\n";
echo "   - Code: {$package->package_code}\n";
echo "   - Statut final: {$package->status}\n";
echo "   - Tentatives: {$package->unavailable_attempts}\n";
echo "   - En attente retour depuis: " . ($package->awaiting_return_since ? $package->awaiting_return_since->diffForHumans() : 'N/A') . "\n";
echo "   - Retourn√© au client: " . ($package->returned_to_client_at ? $package->returned_to_client_at->diffForHumans() : 'N/A') . "\n\n";

echo "üìÆ COLIS RETOUR:\n";
echo "   - Code: {$returnPackage->return_package_code}\n";
echo "   - Statut: {$returnPackage->status}\n";
echo "   - Imprim√©: " . ($returnPackage->printed_at ? 'Oui' : 'Non') . "\n";
echo "   - Livr√©: " . ($returnPackage->delivered_at ? 'Oui - ' . $returnPackage->delivered_at->diffForHumans() : 'Non') . "\n\n";

// ============================================================================
// √âTAPE 5: Tests des m√©thodes du mod√®le
// ============================================================================
echo "üß™ √âTAPE 5: Tests des m√©thodes du mod√®le ReturnPackage...\n";
echo str_repeat("-", 60) . "\n\n";

echo "   - isPrinted(): " . ($returnPackage->isPrinted() ? 'true' : 'false') . "\n";
echo "   - G√©n√©ration code unique: " . ReturnPackage::generateReturnCode() . "\n";
echo "   - Relation originalPackage: " . ($returnPackage->originalPackage ? '‚úÖ OK' : '‚ùå Erreur') . "\n";

echo "\n";

// ============================================================================
// R√âSULTAT FINAL
// ============================================================================
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
echo "   R√âSULTAT FINAL DU TEST\n";
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";

$allTestsPassed = (
    $returnPackagesExists &&
    $returnFieldsExists &&
    $package->status === 'RETURN_CONFIRMED' &&
    $returnPackage->status === 'DELIVERED'
);

if ($allTestsPassed) {
    echo "‚úÖ‚úÖ‚úÖ TOUS LES TESTS SONT PASS√âS AVEC SUCC√àS ! ‚úÖ‚úÖ‚úÖ\n\n";
    echo "Le syst√®me de retours fonctionne correctement:\n";
    echo "  1. ‚úÖ Migrations OK\n";
    echo "  2. ‚úÖ Workflow AWAITING_RETURN ‚Üí RETURN_IN_PROGRESS (48h)\n";
    echo "  3. ‚úÖ Cr√©ation colis retour OK\n";
    echo "  4. ‚úÖ Livraison retour ‚Üí RETURNED_TO_CLIENT\n";
    echo "  5. ‚úÖ Auto-confirmation apr√®s 48h ‚Üí RETURN_CONFIRMED\n";
} else {
    echo "‚ö†Ô∏è  CERTAINS TESTS ONT √âCHOU√â\n\n";
    echo "V√©rifiez les d√©tails ci-dessus pour identifier les probl√®mes.\n";
}

echo "\n";
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
echo "   Voulez-vous nettoyer les donn√©es de test ? (O/N)\n";
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";

$handle = fopen("php://stdin", "r");
$line = fgets($handle);
if (trim(strtoupper($line)) === 'O') {
    echo "\nüßπ Nettoyage des donn√©es de test...\n";

    if (isset($returnPackage)) {
        $returnPackage->delete();
        echo "   ‚úÖ Colis retour supprim√©\n";
    }

    if (isset($package)) {
        $package->delete();
        echo "   ‚úÖ Colis original supprim√©\n";
    }

    echo "   ‚úÖ Nettoyage termin√©\n";
} else {
    echo "\nüìù Les donn√©es de test ont √©t√© conserv√©es pour inspection.\n";
}

fclose($handle);

echo "\n‚ú® Test termin√© !\n\n";

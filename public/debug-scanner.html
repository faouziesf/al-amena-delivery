<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” DEBUG Scanner Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        input { padding: 10px; margin: 5px; width: 300px; border: 1px solid #ddd; border-radius: 5px; }
        #log { height: 300px; overflow-y: auto; background: #000; color: #00ff00; padding: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ” Scanner Debug Test</h1>

    <!-- Debug Console -->
    <div class="debug">
        <h3>Console Log</h3>
        <div id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <!-- Test Form -->
    <div class="debug">
        <h3>Test Scanner</h3>
        <input type="text" id="testCode" value="PKG_CLQVFCWP_20250921" placeholder="Code Ã  tester">
        <br>
        <button class="btn-primary" onclick="testScan()">Test Scan</button>
        <button class="btn-success" onclick="testValidCode()">Test Code Valide</button>
        <button class="btn-danger" onclick="testInvalidCode()">Test Code Invalide</button>
    </div>

    <!-- Status -->
    <div id="status" class="debug">
        Status: PrÃªt Ã  tester
    </div>

    <!-- Result -->
    <div id="result" class="debug" style="display: none;">
        <!-- RÃ©sultat ici -->
    </div>

    <script>
        console.log('ğŸš€ DEBUG Scanner Page chargÃ©e');
        log('ğŸš€ DEBUG Scanner Page chargÃ©e');

        // Logger dans la page ET console
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;

            console.log(logEntry);
            if (logDiv) {
                logDiv.innerHTML += logEntry + '\n';
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'debug';
            if (type === 'error') statusDiv.className += ' error';
            if (type === 'success') statusDiv.className += ' success';
            if (type === 'warning') statusDiv.className += ' warning';
            log(`STATUS: ${message}`);
        }

        // VÃ©rifier les prÃ©requis
        function checkPrerequisites() {
            log('ğŸ” VÃ©rification des prÃ©requis...');

            // Check fetch API
            if (typeof fetch !== 'undefined') {
                log('âœ… Fetch API disponible');
            } else {
                log('âŒ Fetch API non disponible');
            }

            // Test de l'URL
            const testUrl = '/deliverer/packages/scan';
            log(`ğŸŒ URL de test: ${window.location.origin}${testUrl}`);
        }

        // Fonction de scan ultra-simple
        async function simpleScan(code) {
            log(`ğŸ“¦ DÃ©but scan pour code: "${code}"`);
            setStatus('Scan en cours...', 'warning');

            try {
                // PrÃ©parer la requÃªte
                const url = '/deliverer/packages/scan';

                log(`ğŸ“¡ URL: ${url}`);

                const requestData = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                };

                log(`ğŸ“¤ Request data: ${JSON.stringify(requestData, null, 2)}`);

                // Faire la requÃªte
                log('ğŸš€ Envoi de la requÃªte...');
                const response = await fetch(url, requestData);

                log(`ğŸ“¥ Response status: ${response.status}`);
                log(`ğŸ“¥ Response ok: ${response.ok}`);

                // Analyser la rÃ©ponse
                const data = await response.json();
                log(`ğŸ“‹ Response data: ${JSON.stringify(data, null, 2)}`);

                // Afficher le rÃ©sultat
                showResult(response.ok, data);

                if (response.ok) {
                    setStatus('Scan rÃ©ussi!', 'success');
                } else {
                    setStatus('Scan Ã©chouÃ©: ' + response.status, 'error');
                }

            } catch (error) {
                log(`âŒ ERREUR: ${error.message}`);
                log(`âŒ Stack: ${error.stack}`);
                setStatus('Erreur: ' + error.message, 'error');
                showResult(false, { message: error.message });
            }
        }

        // Afficher le rÃ©sultat
        function showResult(success, data) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';

            let html = `<h3>${success ? 'âœ… SuccÃ¨s' : 'âŒ Erreur'}</h3>`;

            if (success && data.package) {
                html += `
                    <p><strong>Code:</strong> ${data.package.code}</p>
                    <p><strong>Status:</strong> ${data.package.status}</p>
                `;
                if (data.delivery_info) {
                    html += `
                        <p><strong>Destinataire:</strong> ${data.delivery_info.name || 'N/A'}</p>
                        <p><strong>Adresse:</strong> ${data.delivery_info.address || 'N/A'}</p>
                    `;
                }
                if (data.package.cod_amount > 0) {
                    html += `<p><strong>COD:</strong> ${data.package.formatted_cod || data.package.cod_amount + ' DA'}</p>`;
                }
            } else {
                html += `<p><strong>Message:</strong> ${data.message || 'Erreur inconnue'}</p>`;
            }

            html += `<p><strong>Raw data:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre></p>`;

            resultDiv.innerHTML = html;
            log(`ğŸ“‹ RÃ©sultat affichÃ©: ${success ? 'SUCCÃˆS' : 'Ã‰CHEC'}`);
        }

        // Fonctions de test
        function testScan() {
            const code = document.getElementById('testCode').value;
            log(`ğŸ§ª Test manuel avec code: "${code}"`);
            simpleScan(code);
        }

        function testValidCode() {
            log('ğŸ§ª Test avec code valide prÃ©dÃ©fini');
            simpleScan('PKG_CLQVFCWP_20250921');
        }

        function testInvalidCode() {
            log('ğŸ§ª Test avec code invalide');
            simpleScan('INVALID_CODE_123');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“„ DOM chargÃ©');
            checkPrerequisites();
            setStatus('PrÃªt Ã  tester');
        });
    </script>
</body>
</html>